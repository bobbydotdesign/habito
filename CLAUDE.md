# Hagotchi - Claude Context

## Project Overview
Hagotchi (hagotchi.com) - A habit tracking app with a retro terminal aesthetic (green on black, monospace fonts). Built with React + Vite, uses Supabase for backend.

## Key Architecture Decisions

### Data Storage
- **habits table**: Main habit data including `streak`, `completed_today`, `completions_today`, `history` (7-day array), `position`, `scheduled_time`, `scheduled_days`
- **completions table**: Historical record of completions by date (source of truth for streak calculations)
- **localStorage cache**: `habito_habits_cache_v2` for faster initial loads

### Streak Calculation
Streaks are calculated from the `completions` table, NOT the `habits.streak` field directly.

**Important lessons learned:**
1. When calculating streaks, start from the **most recent completed date** and count backwards - NOT from today
2. If completions table is empty/sparse, fall back to the `history` array on the habit
3. Never reset streaks during day-change logic - let the recalculation effect handle it
4. When `calculateStreakForHabit` returns `null`, preserve the existing streak value
5. Always default `habit.streak` to 0 if undefined: `const currentStreak = habit.streak || 0`

### Day Change Logic (`checkDayChange`)
- Shifts the `history` array and resets `completed_today`/`completions_today`
- Does NOT touch streaks - streak recalculation happens separately
- Triggered by comparing `localStorage.lastVisit` to current date

### Data Sync
- Cache is invalidated by changing the cache key version (e.g., `_v2`)
- Visibility change handler refetches data when tab becomes active (cross-device sync)
- Background fetches run without timeout when cache exists

## Common Gotchas

### Mobile Touch Events
- Use CSS `touch-action: pan-y` instead of `e.preventDefault()` to handle horizontal swipes
- React adds touch listeners as passive by default, so `preventDefault()` throws errors

### Supabase Timeouts
- Auth refresh can be slow, causing fetch timeouts
- Show cached data immediately, fetch fresh data in background without aggressive timeouts

### State Updates
- When updating habits, always handle null/undefined values: `habit.streak || 0`
- Optimistic updates should include all fields being changed

## File Structure
- `src/components/HabitTracker.jsx` - Main component (large file ~3000+ lines)
- `src/components/BottomSheet.jsx` - Reusable modal/bottom sheet component
- `src/hooks/useCompletions.js` - Hook for recording completions to completions table
- `src/lib/supabase.js` - Supabase client setup
- `src/lib/capacitor.js` - Capacitor platform detection and native features
- `src/services/haptics.js` - Haptic feedback utilities
- `src/services/notifications.js` - Local notification scheduling
- `supabase/migrations/` - Database migrations
- `capacitor.config.json` - Capacitor app configuration
- `ios/` - Native iOS project (generated by Capacitor)

## Styling Conventions
- Terminal aesthetic: green (#00ff41) on black (#0a0a0a)
- Gray scale: #666 (icons), #777 (badges), #888 (labels), #999 (text)
- Mobile uses slightly larger fonts than desktop
- Monospace font family: IBM Plex Mono, Fira Code, SF Mono

## iOS Native App (Capacitor)

### Setup
- App ID: `com.hagotchi.app`
- App Name: `Hagotchi`
- Uses Capacitor 6.x to wrap the React web app
- iOS project in `ios/App/`

### Safe Area Handling
**Critical**: iOS safe areas (Dynamic Island, notch) require careful handling:
- `capacitor.config.json` has `contentInset: "automatic"` which handles some safe area adjustments
- The mobile header uses CSS `top: 0` with `padding-top: env(safe-area-inset-top)`
- The header spacer uses `height: calc(135px + env(safe-area-inset-top))` to push content below
- The floating island uses `bottom: calc(env(safe-area-inset-bottom) + 16px)`

### iOS WebView Scroll & Fixed Positioning
**Critical**: iOS WebView has issues with `position: fixed` and scroll:
- To prevent viewport bounce/shift when scrolling: set `html, body { overflow: hidden; position: fixed; width: 100%; }`
- Make `#root` the scroll container: `overflow-y: auto; overscroll-behavior-y: none;`
- Fixed elements need GPU acceleration to prevent jitter: `transform: translateZ(0); -webkit-backface-visibility: hidden;`
- Use `minHeight: 'auto'` on mobile containers (not `100vh`) to prevent unnecessary scroll
- Add inline styles for `position: fixed` on mobile as backup to CSS classes

### Splash Screen
- Configured to NOT auto-hide (`launchAutoHide: false`)
- App manually hides splash after boot animation completes via `hideSplashScreen()`
- This prevents a flash/broken screen between native splash and React app load

### Mobile Header
- Uses `.mobile-header` CSS class (defined in `index.css`)
- Fixed position at top with safe area offset via `padding-top: env(safe-area-inset-top)`
- Spacer div with `.mobile-header-spacer` class pushes content below header
- Header height is approximately 135px (without safe area)
- Also has inline styles on mobile for `position: fixed` as backup

### Floating Island (Mobile Navigation)
- Uses `.floating-island` CSS class for bottom navigation bar
- Contains: navigation arrows (←→), today/activity tabs, add habit button (+)
- Fixed position at bottom with safe area offset
- Spacer div with `.floating-island-spacer` class prevents content from being hidden behind it
- Square corners to match terminal aesthetic
- Layout: arrows on left, tabs centered, + button on right

### Boot Animation
- Shows terminal-style boot messages on app launch
- Ends with "> ready_" with blinking cursor
- Fades out smoothly before transitioning to main app
- `hideSplashScreen()` is called after boot animation completes

### Haptics
- Use `hapticMedium()` for habit completions
- Use `hapticLight()` for button taps
- Use `hapticSuccess()` for 100% daily completion
- Only triggers on native platform (no-op on web)

### AutoFocus on Mobile
- Set `autoFocus={!isMobile}` on form inputs in modals
- Prevents keyboard from auto-opening on iOS when modals open

## Hagotchi Companion System

### Overview
Virtual pet companion that responds to habit completions. Lives in the Today view above the habits list.

### Data Storage
- **hagotchi_spirit table**: Stores user's companion state
  - `active_skin_id`: Current character (e.g., 'egbert')
  - `vitality`: 0-100, decays 2 points/hour, gains 15-25 per habit completion
  - `unlocked_skin_ids`: Array of unlocked character IDs
  - `total_habits_completed`: Lifetime count for unlock milestones
  - `longest_streak`: For streak-based unlocks
- **localStorage cache**: `hagotchi_cache_v2` for faster loads

### Characters (15 total)
| Rarity | Characters | Unlock |
|--------|------------|--------|
| Common | Egbert (default), Pum, Bell | Start, 3-day streak, 10 habits |
| Uncommon | Buns, Doog, Dock, Gose | 7-day streak, 25 habits, 14-day streak, 50 habits |
| Rare | Axol, Snee, Turmy, Boom | 21-day streak, 75 habits, 30-day streak, 100 habits |
| Epic | Brr, Rac, OOO | 45-day streak, 150 habits, 60-day streak |
| Legendary | Rad | 200 habits |

### File Structure
- `src/components/hagotchi/HagotchiCompanion.jsx` - Main display component
- `src/components/hagotchi/SkinCollection.jsx` - Character selection modal
- `src/components/hagotchi/LoreArchive.jsx` - Character backstories modal
- `src/components/hagotchi/UnlockAnimation.jsx` - New character unlock animation
- `src/data/hagotchiSkins.js` - Character definitions, rarities, unlock conditions
- `src/hooks/useHagotchi.js` - State management, Supabase sync
- `public/hagotchi/*.svg` - Character sprite SVGs (pixel art in terminal green)

### Vitality States
- **Thriving** (80-100): Full opacity, green glow, bouncing animation
- **Content** (40-79): Slight opacity reduction, bouncing
- **Tired** (20-39): Reduced opacity, orange color, no bounce
- **Dormant** (0-19): Very faded, grayscale, "zzz" indicator

### Important Gotchas
1. **Skin ID Migration**: Old ASCII art skin IDs (pixel_spirit, ember_wisp, etc.) auto-migrate to new IDs (egbert, pum, etc.) on fetch
2. **Fallback Skin**: `getSkinById()` returns SKINS[0] (Egbert) if ID not found
3. **Cache Invalidation**: Bump `hagotchi_cache_v2` version to force refresh
4. **Display Condition**: Only shows when `selectedView === 'today' && spirit && currentSkin`
5. **New User Creation**: Spirit auto-creates on first fetch if none exists (PGRST116 error handling)

### Expandable Header (Mobile)
The Hagotchi header has two states:
- **Expanded**: Large hero with character, hearts, encouragement bubble - shown at top of page
- **Collapsed**: Compact header with small character + hearts - slides in when scrolled

**Scroll behavior:**
- Expanded hero is in the scrollable content area (not fixed)
- Fixed compact header is hidden (`translateY(-100%)`) when at top
- After scrolling 280px, compact header slides in (`translateY(0)`)
- Scrolling back to <50px hides compact header again

**Critical: Scroll Spacer**
A spacer at the bottom of content ensures enough scroll room to trigger the compact header:
```jsx
<div style={{ height: 'max(300px, 50vh)' }} />
```
- **Must use viewport-relative units** (vh), not fixed px
- Fixed px spacers break on different screen sizes - content fits without scrolling 280px
- `max(300px, 50vh)` guarantees enough scroll room on any screen
- This has been a recurring bug - DO NOT change to fixed px values

### Supabase Migration
The `hagotchi_spirit` table must exist. Migration at `supabase/migrations/003_create_hagotchi_spirit_table.sql`.

**Known Issue**: If a `handle_new_user` trigger exists that references a non-existent `profiles` table, user signup will fail with "Database error saving new user". Fix: `DROP FUNCTION IF EXISTS public.handle_new_user() CASCADE;`

## BottomSheet Component
- Slides up from bottom on mobile, centered modal on desktop
- Takes `isMobile` prop to determine behavior
- Has safe area padding at bottom for iPhone home indicator (hidden when keyboard open)
- Header padding: `16px 20px 12px` on mobile
- Content padding: `8px 20px 20px` on mobile

### iOS Keyboard Handling
**Critical**: iOS keyboard handling requires specific configuration to prevent layout issues:

**The Problem**: When the keyboard opens on iOS, it can cause:
1. Fixed-position headers to shift down
2. Input fields to be hidden behind the keyboard

**The Solution** (implemented in BottomSheet.jsx):

1. **Capacitor Keyboard Plugin** (`@capacitor/keyboard`):
   - Set `resize: "none"` in capacitor.config.json to prevent WebView resizing (which causes header shift)
   - Use `Keyboard.setAccessoryBarVisible({ isVisible: false })` to hide the iOS autocomplete bar

2. **Move sheet up when keyboard opens**:
   - Listen to `keyboardWillShow` event to get keyboard height
   - Apply `transform: translateY(-${keyboardHeight}px)` to move the sheet up
   - This positions the sheet directly above the keyboard

3. **Hide safe area spacer when keyboard is open**:
   - The bottom safe area padding (for home indicator) is not needed when keyboard is visible
   - Conditionally render: `{isMobile && keyboardHeight === 0 && <SafeAreaSpacer />}`

4. **Return key behavior on mobile**:
   - On mobile, pressing Return should close the keyboard, not submit the form
   - Use `onKeyDown` to check `if (isMobile) e.target.blur()` instead of submitting

**Key code pattern** (BottomSheet.jsx):
```javascript
// Listen for keyboard
const showListener = Keyboard.addListener('keyboardWillShow', (info) => {
  setKeyboardHeight(info.keyboardHeight);
});

// Move sheet up with transform
transform: isMobile
  ? (isAnimating ? `translateY(-${keyboardHeight}px)` : 'translateY(100%)')
  : ...
```

**capacitor.config.json**:
```json
"Keyboard": {
  "resize": "none"
}
```
